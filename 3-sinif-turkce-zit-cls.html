<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zıt Anlamlı Kelimeler Çalışma Sayfası</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Quicksand (Genel) ve Caveat (El Yazısı) -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&family=Caveat:wght@400..700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Değişkenleri (Kullanıcının tercihleri entegre edildi) */
        :root {
            --page-bg: #fdfdf6; /* Defter kâğıdı rengi */
            --text-color: #333;
            --line-color: #cce0ff; /* Açık mavi çizgi rengi */
            --margin-line-color: rgba(255, 150, 150, 0.6); /* Kırmızı kenar çizgisi */
            --accent-color: #007bff;
            --example-color: #e91e63;
            --ink-color: #0d47a1; /* Koyu mavi mürekkep rengi */
            
            /* Fluid birimler (Mobile uyumlu) */
            --line-height: 3rem; /* Satır yüksekliği: 48px */
            --margin-width: 4rem; /* Kenar boşluğu genişliği: 64px */
        }

        /* Temel Fontlar ve Arka Plan */
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #e8e8e3;
            color: var(--text-color);
        }
        .font-caveat {
            font-family: 'Caveat', cursive;
        }
        
        /* Defter çizgisi arka planı - Sadece yazı alanına uygulanır */
        .notebook-lines {
            background-color: var(--page-bg);
            /* Çizgi tekrarını ve rengini ayarla */
            background-image: repeating-linear-gradient(to bottom, 
                transparent, 
                transparent calc(var(--line-height) - 1px), 
                var(--line-color) calc(var(--line-height) - 1px), 
                var(--line-color) var(--line-height)
            );
            background-position-y: 1.5rem; /* Başlık altından hizala */
            background-size: 100% var(--line-height);
        }

        /* Cevap alanı alt çizgi efekti (Kullanıcı girdisini vurgulamak için) */
        .answer-space:not(.example-answer) {
            border-bottom: 1px dashed rgba(0, 0, 0, 0.2); 
            transition: border-color 0.2s;
            cursor: text;
        }
        .answer-space:focus {
            outline: none;
            border-bottom-color: var(--ink-color);
            background-color: rgba(0, 123, 255, 0.05);
            border-radius: 3px;
        }

        /* Word Item yüksekliğini satır yüksekliğine sabitle */
        .word-item {
            height: var(--line-height);
            line-height: var(--line-height);
        }
        
        /* Loading animasyonu için CSS */
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        .animate-spin {
          animation: spin 1s linear infinite;
        }

        /* Baskı (Print) Ayarları - A4 Kağıt Düzeni */
        @media print {
            body {
                background-color: #fff !important;
                padding: 0 !important;
            }
            .worksheet-container {
                box-shadow: none !important;
                margin: 0 !important;
                width: 210mm; /* A4 genişliği */
                min-height: 297mm; /* A4 yüksekliği */
                /* Sol kenar boşluğu (margin-width) + içerik sağ/üst/alt boşluğu */
                padding: 15mm 15mm 15mm 0 !important;
            }
            /* Grid ile ayırdığımız alanı mm cinsinden sabitle */
            .worksheet-content {
                 grid-template-columns: 35mm 1fr !important; /* 35mm marj alanı + içerik */
            }
            .red-line {
                 background-color: var(--margin-line-color) !important;
            }
            .print-button-container, .hole, .feedback-icon {
                display: none !important; /* Buton, delikler ve ikonları gizle */
            }
            .answer-space {
                 border-bottom: none !important; /* Baskıda alt çizgiyi kaldır */
            }
            .notebook-lines {
                /* Baskıda arka plan çizgilerini hafiflet */
                background-color: #fff;
                background-image: repeating-linear-gradient(to bottom, 
                    transparent, 
                    transparent calc(var(--line-height) - 1px), 
                    rgba(204, 224, 255, 0.6) calc(var(--line-height) - 1px), 
                    rgba(204, 224, 255, 0.6) var(--line-height)
                );
            }
            footer {
                left: 35mm !important;
                width: calc(100% - 50mm) !important;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 md:p-8">

    <!-- Yazdırma Butonu ve Kontrol Butonu -->
    <div class="print-button-container w-full max-w-4xl text-center mb-6 flex justify-center space-x-4" id="printButtonContainer">
        <button onclick="window.print()"
            class="print-button bg-[var(--accent-color)] hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-xl transition duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
            <span class="mr-2">🖨️</span> Yazdır / PDF Olarak Kaydet
        </button>
        <!-- Gemini API Entegrasyonu: Cevap Kontrolü -->
        <button onclick="checkAnswers()"
            class="llm-button bg-pink-600 hover:bg-pink-700 text-white font-semibold py-3 px-8 rounded-xl transition duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
            <span class="mr-2">✨</span> Cevapları Kontrol Et
        </button>
    </div>

    <!-- Çalışma Sayfası Konteyneri (Mobil/Fluid + Baskı için A4) -->
    <div class="worksheet-container bg-[var(--page-bg)] max-w-4xl w-full min-h-[85vh] shadow-xl rounded-lg overflow-hidden relative flex flex-col">
        
        <!-- İçerik Alanı: Kenar Boşluğu + Yazı Alanı (Grid ile ayrıldı) -->
        <div class="worksheet-content flex-grow grid grid-cols-[var(--margin-width)_1fr] relative p-4 sm:p-8 md:p-12 pb-20">

            <!-- SOL MARJ ALANI (Delikler ve Kırmızı Çizgi) -->
            <div class="paper-margin relative h-full flex-shrink-0">
                
                <!-- Kırmızı Çizgi -->
                <div class="red-line absolute top-0 right-0 w-[2px] h-full bg-[var(--margin-line-color)] z-10"></div>
                
                <!-- Defter Delikleri (Merkeze hizalandı) -->
                <div class="hole-punches absolute inset-y-0 left-1/2 -translate-x-1/2 flex flex-col justify-evenly py-8">
                    <!-- Delik sayısını artırarak A4 formatına yaklaştırdık -->
                    <div class="hole w-3 h-3 bg-stone-200 border border-gray-300 rounded-full shadow-inner"></div>
                    <div class="hole w-3 h-3 bg-stone-200 border border-gray-300 rounded-full shadow-inner"></div>
                    <div class="hole w-3 h-3 bg-stone-200 border border-gray-300 rounded-full shadow-inner"></div>
                    <div class="hole w-3 h-3 bg-stone-200 border border-gray-300 rounded-full shadow-inner"></div>
                    <div class="hole w-3 h-3 bg-stone-200 border border-gray-300 rounded-full shadow-inner"></div>
                    <div class="hole w-3 h-3 bg-stone-200 border border-gray-300 rounded-full shadow-inner"></div>
                    <div class="hole w-3 h-3 bg-stone-200 border border-gray-300 rounded-full shadow-inner"></div>
                    <div class="hole w-3 h-3 bg-stone-200 border border-gray-300 rounded-full shadow-inner"></div>
                </div>

            </div>

            <!-- SAĞ YAZI ALANI (Başlık ve Çizgili İçerik) -->
            <div class="paper-writing notebook-lines h-full pt-4 md:pt-2">
                <header class="mb-6 px-1">
                    <h1 class="text-xl md:text-2xl font-bold text-gray-800 border-b-2 border-gray-200 pb-2">
                        1. Aşağıda verilen kelimelerin zıt anlamlarını örnekteki gibi yazalım.
                    </h1>
                </header>

                <main class="h-full">
                    <div class="columns grid grid-cols-1 sm:grid-cols-2 gap-x-10 gap-y-4 px-1">
                        <!-- Bu div'ler script tarafından doldurulacak -->
                        <div class="column col-span-1"></div>
                        <div class="column col-span-1"></div>
                    </div>
                </main>
            </div>
        </div>

        <!-- Alt Bilgi -->
        <footer class="w-full absolute bottom-4 left-0 right-0 flex justify-between text-sm md:text-base font-medium text-gray-500 px-12 md:px-16">
            <div class="footer-left">ilkokulakademi.com</div>
            <div class="footer-right">3. Sınıf Türkçe | Sayfa 1</div>
        </footer>
    </div>

    <!-- JavaScript ile Kelimeleri Dinamik Olarak Oluşturma ve Gemini Kontrolü -->
    <script>
        // Sayfayı dolduracak kelimeler listesi
        const words = [
            { word: "uzak", answer: "yakın", isExample: true },
            { word: "taze", answer: "bayat" },
            { word: "eski", answer: "yeni" },
            { word: "ince", answer: "kalın" },
            { word: "dar", answer: "geniş" },
            { word: "büyük", answer: "küçük" },
            { word: "erken", answer: "geç" },
            { word: "yüksek", answer: "alçak" },
            { word: "aydınlık", answer: "karanlık" },
            { word: "gece", answer: "gündüz" },
            { word: "yumuşak", answer: "sert" },
            { word: "şişman", answer: "zayıf" },
            { word: "genç", answer: "yaşlı" },
            { word: "kirli", answer: "temiz" },
            { word: "az", answer: "çok" },
            { word: "siyah", answer: "beyaz" },
        ];

        const columns = document.querySelectorAll('div.columns > .column');

        // Kelimeleri sütunlara dağıtma
        words.forEach((item, index) => {
            const columnIndex = index % 2; // Basitçe iki sütuna dağıt
            const column = columns[columnIndex];
            
            const answerClass = item.isExample ? 'example-answer' : 'answer-space';
            const contentEditable = item.isExample ? '' : 'contenteditable="true"';
            
            // Eğer örnekse cevabı göster (pembe), değilse boş bırak (mavi/koyu)
            const answerContent = item.isExample ? item.answer : ''; 

            const html = `
                <div class="word-item flex items-center text-lg md:text-xl relative">
                    <span class="word font-medium w-16 text-gray-700">${item.word}</span>
                    <span class="arrow text-[var(--accent-color)] mx-2">→</span>
                    <span class="${answerClass} ${item.isExample ? 'text-[var(--example-color)]' : 'text-[var(--ink-color)]'} font-caveat text-3xl flex-grow px-1" 
                          ${contentEditable}>${answerContent}</span>
                </div>
            `;
            column.insertAdjacentHTML('beforeend', html);
        });

        // =========================================================================
        // GEMINI API ENTEGRASYONU: CEVAP KONTROLÜ
        // =========================================================================

        /**
         * LLM API çağrısını üstel geri çekilme (exponential backoff) ile dener.
         */
        async function retryFetch(url, payload, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    } else if (response.status === 429 && i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        throw new Error(`API çağrısı başarısız oldu: ${response.status}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error("Son API çağrısı denemesi başarısız oldu:", error);
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            throw new Error("Çoklu denemeden sonra API çağrısı başarısız oldu.");
        }

        /**
         * Öğrencinin cevaplarını toplar ve Gemini API'yi kullanarak doğruluğunu kontrol eder.
         */
        async function checkAnswers() {
            const checkButton = document.querySelector('.llm-button');
            const originalWords = document.querySelectorAll('.word');
            const answerSpaces = document.querySelectorAll('.answer-space[contenteditable="true"]');
            
            // Önceki geri bildirim simgelerini temizle
            document.querySelectorAll('.feedback-icon').forEach(icon => icon.remove());
            
            // Kullanıcı verilerini topla
            const userAnswers = [];
            let promptText = "Aşağıdaki kelime çiftlerinin zıt anlamlı olup olmadığını kontrol et. Cevap boş bırakılmışsa veya geçersizse 'is_correct: false' olarak işaretle. Cevabın doğruluğuna bakarken Türkçe'deki en yaygın ve kabul görmüş zıt anlamlı kelimeyi kullan. Çiftler:\n";

            answerSpaces.forEach((space, index) => {
                // index + 1 çünkü ilk eleman örnek (uzak → yakın)
                const wordElement = originalWords[index + 1]; 
                const word = wordElement.textContent.trim();
                const userAnswer = space.textContent.trim().toLowerCase();

                userAnswers.push({ word, userAnswer, element: space });
                promptText += `\nKelime: "${word}", Öğrenci Cevabı: "${userAnswer}"`;
            });

            if (userAnswers.length === 0 || !userAnswers.some(a => a.userAnswer !== '')) {
                alert("Lütfen kontrol için en az bir kelimenin zıt anlamını yazın.");
                return;
            }

            // Yükleme durumunu ayarla
            checkButton.disabled = true;
            checkButton.innerHTML = '<span class="mr-2 animate-spin">⏳</span> Kontrol Ediliyor...';

            const apiKey = ""; // Canvas ortamı tarafından sağlanır
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = "Sen, Türkçe dilbilgisi ve kelime bilgisi konusunda uzman, ilkokul seviyesine uygun geri bildirimler veren bir öğretmensin. Görevin, öğrencilerin zıt anlamlı kelimeler alıştırmasındaki cevaplarını kontrol etmektir. Yanıtını daima verilen JSON şemasına uygun olarak, sadece JSON olarak döndürmelisin. Geri bildirim (feedback_tr) kısa, teşvik edici ve doğru kelimeyi belirten nitelikte olmalıdır.";

            const payload = {
                contents: [{ parts: [{ text: promptText }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "word": { "type": "STRING" },
                                "user_answer": { "type": "STRING" },
                                "is_correct": { "type": "BOOLEAN" },
                                "correct_answer": { "type": "STRING" },
                                "feedback_tr": { "type": "STRING" }
                            },
                            "propertyOrdering": ["word", "user_answer", "is_correct", "correct_answer", "feedback_tr"]
                        }
                    }
                }
            };
            
            try {
                const result = await retryFetch(apiUrl, payload);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonText) {
                    throw new Error("API'den geçerli JSON yanıtı alınamadı.");
                }

                const feedbackArray = JSON.parse(jsonText);

                // Geri bildirimi işle ve göster
                let correctCount = 0;
                const totalCount = feedbackArray.length;

                userAnswers.forEach((item) => {
                    const feedback = feedbackArray.find(f => f.word === item.word);
                    const parent = item.element.closest('.word-item');

                    if (feedback) {
                        const icon = document.createElement('span');
                        // absolute -right-12: word-item'a göre sağa 3rem (48px) dışarıya konumlandırır.
                        icon.classList.add('feedback-icon', 'ml-2', 'text-2xl', 'absolute', '-right-12', 'top-1/2', '-translate-y-1/2', 'cursor-pointer');
                        
                        if (feedback.is_correct) {
                            icon.textContent = '✅';
                            correctCount++;
                            parent.classList.add('transition', 'bg-green-50/50', 'rounded');
                            setTimeout(() => parent.classList.remove('bg-green-50/50'), 2000);
                        } else {
                            icon.textContent = '❌';
                            parent.classList.add('transition', 'bg-red-50/50', 'rounded');
                            setTimeout(() => parent.classList.remove('bg-red-50/50'), 2000);
                        }

                        // Detaylı geri bildirim için title/tooltip ekle
                        icon.setAttribute('title', feedback.feedback_tr);
                        parent.appendChild(icon);
                    }
                });

                // Tamamlanma mesajını göster
                alert(`Kontrol tamamlandı! ${totalCount} sorudan ${correctCount} tanesi doğru. Yanlış cevaplar (❌) için simgenin üzerine gelerek geri bildirimi okuyabilirsiniz.`);

            } catch (error) {
                console.error("Cevapları kontrol ederken bir hata oluştu:", error);
                alert("Cevapları kontrol etme sırasında bir hata oluştu. Konsolu kontrol edin.");
            } finally {
                // Yükleme durumunu sıfırla
                checkButton.disabled = false;
                checkButton.innerHTML = '<span class="mr-2">✨</span> Cevapları Kontrol Et';
            }
        }
    </script>
</body>
</html>
